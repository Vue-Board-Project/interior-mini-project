<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mycompany.webapp.dao.mybatis.PurchaseDao">
	<resultMap id="selectForCart" type = "purchase">
			<result column = "payment_amount" property = "paymentAmount" />
            <result column = "purchase_quantity" property = "purchaseQuantity" />
         <association property="pDetail" javaType="pDetail">
            <result column = "model_purchase_quantity" property = "modelPurchaseQuantity" />
         </association>
         <association property="product" javaType="product">
         	<result column = "model_number" property = "modelNumber" />
            <result column = "product_name" property = "productName" />
            <result column = "price" property = "price" />
            <result column = "product_Quantity" property = "productQuantity" />
         </association>
   </resultMap>
	<select id="selectPay" parameterType="string" resultMap="selectForCart">
		   select 
		pr.model_number
		, pr.product_name
		, pr.price
		, pr.product_Quantity
		, pu.payment_amount
		, pu.purchase_quantity
		, pud.model_purchase_quantity
		, pud.detail_price
		from product pr, purchase_detail pud, purchase pu
		where pr.model_Number=pud.model_Number and
		pr.model_Number = #{modelNum}
	</select>

	<!-- 구매 버튼 클릭 시 추가 내용 -->
	<insert id="insertPurchaseInfo" parameterType="purchase">
		<selectKey keyProperty="purchaseNumber" resultType="int" order="BEFORE">
	         select PURCHASE_SEQUENCE.nextval from dual
	    </selectKey>
		insert into purchase(
			PURCHASE_NUMBER 
			, PURCHASE_DATE
			, PAYMENT_AMOUNT
			, PURCHASE_QUANTITY
			, DELIVERY_MANAGEMENT
			, EMAIL
			, BANK
			, CARDNUMBER
			, CARDDATE
			)
		values(
			#{purchaseNumber}
			, sysdate
			, #{paymentAmount}
			, #{purchaseQuantity}
			, '배송 준비중'
			, #{stringEmail},
			  #{bank},
			  #{cardnumber},
			  #{carddate}
		)
	</insert>
	<insert id="insertPurchaseDetailInfo" parameterType="pDetail">
		
		insert into PURCHASE_DETAIL(
			PURCHASE_NUMBER
			, MODEL_NUMBER
			, MODEL_PURCHASE_QUANTITY
			)
		values(
			#{intPurchaseNumber}
			, #{stringModelNumber}
			, #{modelPurchaseQuantity}
			)
	</insert>

	<update id="updateProductInfo" parameterType="product">
		update product set 
			PRODUCT_QUANTITY=#{productQuantity}
			, PRODUCT_SALES_VOLUME=#{productSalesVolume}
		where model_Number = #{modelNumber}
	</update>
</mapper>